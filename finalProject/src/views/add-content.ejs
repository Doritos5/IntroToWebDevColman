<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Add New Content</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="/settings/settings.css">
    <style>
        body.add-content-page { background:#000; color:#fff; min-height:100vh; }
        .hero-bg { position:fixed; inset:0; z-index:-2; background:url('/images/catalog_background.jpg') center/cover no-repeat; filter: blur(6px) brightness(.55); transform: scale(1.03); }
        .hero-overlay { position:fixed; inset:0; z-index:-1; background: rgba(0,0,0,.5); }

        /* Form styling */
        .content-shell { max-width: 980px; margin: 48px auto; padding: 0 16px; }
        .content-card { background: rgba(0,0,0,.72); backdrop-filter: saturate(120%) blur(6px); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; }
    .content-header { padding: 1rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,.08); display:flex; flex-direction:column; align-items:flex-start; gap:.25rem; }
    .content-header h2 { margin:0; letter-spacing:.02em; }
    .content-header .subtitle { line-height: 1.2; }
        .content-body { padding: 1.25rem; }

        .message-box { margin: 1rem 0; padding: .75rem 1rem; border-radius: 8px; font-weight: 600; }
        .message-success { background: #063d24; color: #44d79c; border: 1px solid #1c6f4d; }
        .message-error { background: #4d0410; color: #ff6b7d; border: 1px solid #802637; }

        .form-label { font-size:.8rem; color:#cfcfcf; }
        .form-control, .form-select { background:#0f0f0f; border-color:#2a2a2a; color:#fff; }
        .form-control:focus, .form-select:focus { border-color:#444; box-shadow:none; background:#161616; color:#fff; }

        /* Drag & drop upload */
        .dropzone { border: 1px dashed rgba(255,255,255,.3); border-radius: 12px; padding: 1.25rem; text-align: center; cursor: pointer; transition: all .2s ease; background:#0b0b0b; }
        .dropzone:hover { border-color: rgba(255,255,255,.6); background:#121212; }
        .dropzone.dragover { background: #111418; border-color: #6ea8fe; }
        .small-hint { color:#9da3a9; font-size:.8rem; }

        .poster-preview { width: 180px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(255,255,255,.12); background:#0f0f0f; }
        .d-none-imp { display:none !important; }

        /* Type selector styling */
        .type-section { background:#0b0b0b; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:1rem; }
        .btn-toggle-group .btn { 
            background:#101010; 
            border-color:#2a2a2a; 
            color:#eaeaea; 
            padding:.4rem .9rem; 
            border-radius:999px; 
            transition: all .15s ease;
        }
        .btn-toggle-group .btn:hover { background:#161616; border-color:#3a3a3a; color:#fff; }
        .btn-check:checked + .btn { background:#1f1f1f; border-color:#6f6f6f; color:#fff; box-shadow: 0 0 0 2px rgba(255,255,255,.08) inset; }
    .type-hint { color:#9da3a9; font-size:.8rem; }
    .type-header { display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; }

    </style>
</head>
<body class="add-content-page">
    <div class="hero-bg"></div>
    <div class="hero-overlay"></div>

    <div class="content-shell">
        <div class="content-card">
            <div class="content-header">
                <div>
                    <h2 class="mb-0">Add New Content</h2>
                    <div class="subtitle text-secondary small">Upload MP4 and details. Ratings auto-fetched from IMDb.</div>
                </div>
            </div>
            <div class="content-body">
                <% if (message) { %><div class="message-box message-success"><%= message %></div><% } %>
                <% if (error) { %><div class="message-box message-error"><%= error %></div><% } %>

                <form action="/add-content" method="post" enctype="multipart/form-data" id="addContentForm">
                    <div class="row g-3">
                        <div class="col-sm-7">
                            <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                            <input id="title" name="title" type="text" class="form-control" required placeholder="Movie/Series title">
                        </div>
                        <div class="col-sm-2">
                            <label for="year" class="form-label">Year <span class="text-danger">*</span></label>
                            <input id="year" name="year" type="number" class="form-control" min="1900" max="2100" placeholder="2025" required>
                        </div>
                        <div class="col-sm-3 d-flex flex-column align-items-start">
                            <label class="form-label">Poster <span class="text-danger">*</span></label>
                            <img id="posterPreview" class="poster-preview mb-2" alt="Poster preview" />
                            <input id="poster" name="poster" type="text" class="form-control" placeholder="https://..." required>
                        </div>

                        <div class="col-12">
                            <label for="genres" class="form-label">Genres (comma separated) <span class="text-danger">*</span></label>
                            <input id="genres" name="genres" type="text" class="form-control" placeholder="Action, Sci-Fi" required>
                            <div class="small-hint mt-1">Example: Action, Drama, Sci-Fi</div>
                        </div>

                        <div class="col-12">
                            <label for="description" class="form-label">Description</label>
                            <textarea id="description" name="description" rows="3" class="form-control" placeholder="Short description"></textarea>
                        </div>

                        <div class="col-12">
                            <div class="type-section">
                                <div class="type-header">
                                    <span class="form-label mb-0">Type</span>
                                    <div class="btn-group btn-toggle-group" role="group" aria-label="Content type">
                                        <input class="btn-check" type="radio" name="type" id="typeMovie" value="movie" checked autocomplete="off">
                                        <label class="btn" for="typeMovie">Movie</label>

                                        <input class="btn-check" type="radio" name="type" id="typeSeries" value="series" autocomplete="off">
                                        <label class="btn" for="typeSeries">Series</label>
                                    </div>
                                </div>
                                <div class="type-hint mt-2">For series, Title is the series name and Episode # is required.</div>
                                <div class="row g-3 mt-2 align-items-end">
                                    <div class="col-md-3 d-none" id="seriesFields" aria-live="polite">
                                        <label for="episodeNumber" class="form-label">Episode # <span class="text-danger">*</span></label>
                                        <input id="episodeNumber" name="episodeNumber" type="number" min="1" class="form-control" placeholder="1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">MP4 Video File <span class="text-danger">*</span></label>
                            <label for="videoFile" id="dropzone" class="dropzone w-100">
                                <div class="small-hint mb-1">Drag & drop your .mp4 here or click to choose</div>
                                <div id="fileName" class="text-white-50">No file selected</div>
                            </label>
                            <input id="videoFile" name="videoFile" type="file" accept="video/mp4" required class="d-none">
                        </div>

                        <div class="col-12 d-flex gap-2 mt-2">
                            <button type="submit" class="btn btn-danger">Add Content</button>
                            <a href="/settings/configuration" class="btn btn-secondary">Back to configuration</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function(){
            const typeMovie = document.getElementById('typeMovie');
            const typeSeries = document.getElementById('typeSeries');
            const seriesFields = document.getElementById('seriesFields');
            const titleInput = document.getElementById('title');
            const posterInput = document.getElementById('poster');
            const posterPreview = document.getElementById('posterPreview');
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('videoFile');
            const fileName = document.getElementById('fileName');

            function updateSeriesVisibility(){
                if (typeSeries.checked) {
                    seriesFields.classList.remove('d-none');
                    document.getElementById('episodeNumber').setAttribute('required', 'required');
                } else {
                    seriesFields.classList.add('d-none');
                    const ep = document.getElementById('episodeNumber');
                    if (ep) ep.value = '';
                    if (ep) ep.removeAttribute('required');
                }
                updateTitlePlaceholder();
            }

            function updateTitlePlaceholder(){
                if (!titleInput) return;
                titleInput.placeholder = 'Movie/Series title';
            }
            typeMovie.addEventListener('change', updateSeriesVisibility);
            typeSeries.addEventListener('change', updateSeriesVisibility);
            updateSeriesVisibility();

            // Poster placeholder and preview handling
            const PLACEHOLDER_POSTER = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='100'><rect width='100%' height='100%' fill='%231c1c1c'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%23555'>No poster</text></svg>";
            function setPosterSrc(url){
                posterPreview.src = (url && url.trim().length > 3) ? url.trim() : PLACEHOLDER_POSTER;
            }
            setPosterSrc('');
            // Fallback on load error
            posterPreview.addEventListener('error', ()=> setPosterSrc(''));
            // Update on input
            posterInput.addEventListener('input', () => setPosterSrc(posterInput.value));

            // Drag & drop
            ['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); }));
            ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); }));
            dropzone.addEventListener('drop', (e)=>{ if(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) { fileInput.files = e.dataTransfer.files; updateFileName(); }});
            fileInput.addEventListener('change', updateFileName);
            function updateFileName(){
                const f = fileInput.files && fileInput.files[0];
                fileName.textContent = f ? f.name : 'No file selected';
            }

            // Year spinner
            const yearInput = document.getElementById('year');
            const YEAR_DEFAULT = 2025;
            let yearInitialized = false;
            yearInput.addEventListener('input', () => {
                if (yearInitialized) return;
                const minVal = parseInt(yearInput.min || '0', 10);
                const currentVal = parseInt(yearInput.value || '0', 10);
                if (!yearInput.value || currentVal === minVal) {
                    yearInput.value = YEAR_DEFAULT;
                }
                yearInitialized = true;
            });

            const form = document.getElementById('addContentForm');
            form.addEventListener('submit', function(e){
                // Let browser do native validation first
                if (!form.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('Please fill in all required fields marked with *.');
                }
            });
        })();
    </script>
</body>
</html>
